<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Camera App</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="card">
                    <h5 class="card-header h5 text-center">
                        HTML 5 & JS Live Cam (Mobile Fixed)
                    </h5>
                    <div class="card-body">
                        <div class="booth">
                            <video id="video" width="100%" height="400" autoplay muted playsinline></video>
                        </div>
                        <div class="text-center mt-3">
                            <div class="form-group">
                                <label for="cameraSelect">Select Camera:</label>
                                <select id="cameraSelect" class="form-control" onChange="onCameraChange()">
                                    <option value="">Loading cameras...</option>
                                </select>
                            </div>
                            <button class="btn btn-danger" onClick="stopCam()">Stop Cam</button>
                            <button class="btn btn-success" onClick="startCam()">Start Cam</button>
                            <button class="btn btn-secondary" onClick="refreshCameras()">Refresh Camera List</button>
                        </div>
                        <div class="mt-3">
                            <div id="error-message" class="alert alert-danger" style="display: none;"></div>
                            <div id="status-message" class="alert alert-info" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let currentStream = null;
        let availableCameras = [];
        let selectedDeviceId = null;
        
        const showError = (message) => {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        };
        
        const showStatus = (message) => {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        };

        const enumerateCameras = async () => {
            try {
                // Request permission first to get device labels
                await navigator.mediaDevices.getUserMedia({ video: true });
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                availableCameras = devices.filter(device => device.kind === 'videoinput');
                
                const cameraSelect = document.getElementById('cameraSelect');
                cameraSelect.innerHTML = '';
                
                if (availableCameras.length === 0) {
                    cameraSelect.innerHTML = '<option value="">No cameras found</option>';
                    showError('No cameras detected. Make sure your USB camera is connected.');
                    return;
                }
                
                // Add default option
                cameraSelect.innerHTML = '<option value="">Select a camera...</option>';
                
                // Add each camera to the dropdown
                availableCameras.forEach((camera, index) => {
                    const option = document.createElement('option');
                    option.value = camera.deviceId;
                    
                    // Create a meaningful label
                    let label = camera.label || `Camera ${index + 1}`;
                    
                    // Add additional info to help identify cameras
                    if (label.includes('front') || label.includes('user')) {
                        label += ' (Front)';
                    } else if (label.includes('back') || label.includes('environment')) {
                        label += ' (Back)';
                    } else if (label.includes('usb') || label.includes('USB')) {
                        label += ' (USB)';
                    }
                    
                    option.textContent = label;
                    cameraSelect.appendChild(option);
                });
                
                // Auto-select first camera if none selected
                if (!selectedDeviceId && availableCameras.length > 0) {
                    selectedDeviceId = availableCameras[0].deviceId;
                    cameraSelect.value = selectedDeviceId;
                }
                
                showStatus(`Found ${availableCameras.length} camera(s)`);
                
            } catch (error) {
                console.error('Error enumerating cameras:', error);
                showError('Error getting camera list: ' + error.message);
                
                const cameraSelect = document.getElementById('cameraSelect');
                cameraSelect.innerHTML = '<option value="">Error loading cameras</option>';
            }
        };

        const onCameraChange = () => {
            const cameraSelect = document.getElementById('cameraSelect');
            selectedDeviceId = cameraSelect.value;
            
            if (selectedDeviceId) {
                showStatus('Camera selected. Click "Start Cam" to use it.');
            }
        };

        const refreshCameras = async () => {
            showStatus('Refreshing camera list...');
            await enumerateCameras();
        };
            const video = document.getElementById('video');
            if (currentStream) {
                const tracks = currentStream.getTracks();
                tracks.forEach(track => track.stop());
                currentStream = null;
            }
            video.srcObject = null;
            showStatus('Camera stopped');
        };

        const startCam = async () => {
            const video = document.getElementById('video');
            
            // Check if getUserMedia is supported
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showError('Camera not supported on this browser');
                return;
            }

            // Check if a camera is selected
            if (!selectedDeviceId) {
                showError('Please select a camera from the dropdown first');
                return;
            }

            try {
                // Stop any existing stream
                if (currentStream) {
                    stopCam();
                }

                showStatus('Starting selected camera...');

                // Use the selected device ID
                const constraints = {
                    video: {
                        deviceId: { exact: selectedDeviceId },
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 }
                    },
                    audio: false
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                
                // Ensure video plays on mobile
                video.onloadedmetadata = () => {
                    video.play().catch(e => {
                        console.error('Error playing video:', e);
                        showError('Error starting video playback');
                    });
                };
                
                const selectedCamera = availableCameras.find(cam => cam.deviceId === selectedDeviceId);
                const cameraName = selectedCamera ? selectedCamera.label || 'Selected Camera' : 'Selected Camera';
                showStatus(`Camera started: ${cameraName}`);
                
            } catch (error) {
                console.error('Camera access error:', error);
                
                // Provide specific error messages
                if (error.name === 'NotAllowedError') {
                    showError('Camera access denied. Please allow camera permissions in your browser settings.');
                } else if (error.name === 'NotFoundError') {
                    showError('Selected camera not found. It may have been disconnected.');
                } else if (error.name === 'NotSupportedError') {
                    showError('Selected camera not supported on this browser.');
                } else if (error.name === 'OverconstrainedError') {
                    showError('Camera constraints not supported. Trying with basic settings...');
                    // Try with basic constraints for the selected device
                    tryBasicCamera();
                } else {
                    showError(`Camera error: ${error.message}`);
                }
            }
        };

        const tryBasicCamera = async () => {
            try {
                const basicConstraints = {
                    video: { deviceId: { exact: selectedDeviceId } },
                    audio: false
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(basicConstraints);
                const video = document.getElementById('video');
                video.srcObject = currentStream;
                
                video.onloadedmetadata = () => {
                    video.play().catch(e => {
                        console.error('Error playing video:', e);
                        showError('Error starting video playback');
                    });
                };
                
                showStatus('Camera started with basic settings');
                
            } catch (error) {
                showError(`Basic camera access failed: ${error.message}`);
            }
        };

        // Check HTTPS requirement
        const checkHTTPS = () => {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                showError('HTTPS required for camera access on mobile devices. Please use HTTPS.');
                return false;
            }
            return true;
        };

        // Initialize when page loads
        $(document).ready(() => {
            if (checkHTTPS()) {
                // Enumerate cameras first
                setTimeout(() => {
                    enumerateCameras();
                }, 500);
            }
        });

        // Handle device changes (USB camera connected/disconnected)
        navigator.mediaDevices.addEventListener('devicechange', () => {
            console.log('Device change detected, refreshing camera list...');
            enumerateCameras();
        });

        // Handle page visibility changes (mobile browsers may pause camera)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Page is hidden, camera might be paused
                console.log('Page hidden, camera may pause');
            } else {
                // Page is visible again, refresh camera list in case devices changed
                console.log('Page visible again, checking for device changes');
                setTimeout(() => {
                    enumerateCameras();
                }, 1000);
            }
        });
    </script>
</body>
</html>
