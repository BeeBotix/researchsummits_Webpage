<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Camera App</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="card">
                    <h5 class="card-header h5 text-center">
                        HTML 5 & JS Live Cam (Mobile Fixed)
                    </h5>
                    <div class="card-body">
                        <div class="booth">
                            <video id="video" width="100%" height="400" autoplay muted playsinline></video>
                        </div>
                        <div class="text-center mt-3">
                            <button class="btn btn-danger" onClick="stopCam()">Stop Cam</button>
                            <button class="btn btn-success" onClick="startCam()">Start Cam</button>
                            <button class="btn btn-info" onClick="switchCamera()">Switch Camera</button>
                        </div>
                        <div class="mt-3">
                            <div id="error-message" class="alert alert-danger" style="display: none;"></div>
                            <div id="status-message" class="alert alert-info" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let currentStream = null;
        let currentFacingMode = 'user'; // 'user' for front camera, 'environment' for back camera
        
        const showError = (message) => {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        };
        
        const showStatus = (message) => {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        };

        const stopCam = () => {
            const video = document.getElementById('video');
            if (currentStream) {
                const tracks = currentStream.getTracks();
                tracks.forEach(track => track.stop());
                currentStream = null;
            }
            video.srcObject = null;
            showStatus('Camera stopped');
        };

        const startCam = async () => {
            const video = document.getElementById('video');
            
            // Check if getUserMedia is supported
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showError('Camera not supported on this browser');
                return;
            }

            try {
                // Stop any existing stream
                if (currentStream) {
                    stopCam();
                }

                showStatus('Requesting camera access...');

                // Enhanced constraints for mobile compatibility
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 }
                    },
                    audio: false
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                
                // Ensure video plays on mobile
                video.onloadedmetadata = () => {
                    video.play().catch(e => {
                        console.error('Error playing video:', e);
                        showError('Error starting video playback');
                    });
                };
                
                showStatus('Camera started successfully');
                
            } catch (error) {
                console.error('Camera access error:', error);
                
                // Provide specific error messages
                if (error.name === 'NotAllowedError') {
                    showError('Camera access denied. Please allow camera permissions in your browser settings.');
                } else if (error.name === 'NotFoundError') {
                    showError('No camera found on this device.');
                } else if (error.name === 'NotSupportedError') {
                    showError('Camera not supported on this browser.');
                } else if (error.name === 'OverconstrainedError') {
                    showError('Camera constraints not supported. Trying with basic settings...');
                    // Try with basic constraints
                    tryBasicCamera();
                } else {
                    showError(`Camera error: ${error.message}`);
                }
            }
        };

        const tryBasicCamera = async () => {
            try {
                const basicConstraints = {
                    video: true,
                    audio: false
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(basicConstraints);
                const video = document.getElementById('video');
                video.srcObject = currentStream;
                
                video.onloadedmetadata = () => {
                    video.play().catch(e => {
                        console.error('Error playing video:', e);
                        showError('Error starting video playback');
                    });
                };
                
                showStatus('Camera started with basic settings');
                
            } catch (error) {
                showError(`Basic camera access failed: ${error.message}`);
            }
        };

        const switchCamera = () => {
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            startCam();
        };

        // Check HTTPS requirement
        const checkHTTPS = () => {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                showError('HTTPS required for camera access on mobile devices. Please use HTTPS.');
                return false;
            }
            return true;
        };

        // Initialize when page loads
        $(document).ready(() => {
            if (checkHTTPS()) {
                // Small delay to ensure DOM is fully ready
                setTimeout(() => {
                    startCam();
                }, 500);
            }
        });

        // Handle page visibility changes (mobile browsers may pause camera)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Page is hidden, camera might be paused
            } else {
                // Page is visible again, restart camera if needed
                const video = document.getElementById('video');
                if (!video.srcObject && !document.hidden) {
                    setTimeout(() => {
                        startCam();
                    }, 1000);
                }
            }
        });
    </script>
</body>
</html>
